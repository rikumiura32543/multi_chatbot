<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - 埋め込みチャット</title>
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="chat-container">
        <!-- チャットヘッダー -->
        <div class="chat-header">
            <div>
                <h2 style="margin: 0;">{{ title }}</h2>
                <div style="font-size: 0.9em; opacity: 0.9;" id="chatbotInfo">読み込み中...</div>
            </div>
            <div style="display: flex; gap: var(--spacing-sm);">
                <button onclick="window.open('/settings/{{ chatbot_id }}', '_blank')" class="btn" style="color: var(--color-black); background: var(--color-white);">
                    設定
                </button>
            </div>
        </div>

        <!-- チャットメッセージ -->
        <div class="chat-messages" id="chatMessages">
            <div class="loading-container" id="welcomeMessage">
                <h3>チャットボットとの対話を開始しましょう</h3>
                <p>下のテキストボックスに質問を入力してください。<br>
                RAG機能により、アップロードされた文書に基づいて回答します。</p>
            </div>
        </div>

        <!-- チャット入力 -->
        <div class="chat-input-container">
            <textarea 
                id="chatInput" 
                class="chat-input" 
                placeholder="メッセージを入力してください..."
                rows="1"
                onkeydown="handleKeyDown(event)"
                oninput="autoResize(this)"
            ></textarea>
            <button id="sendButton" class="send-button" onclick="sendMessage()">
                送信
            </button>
        </div>
    </div>

    <script>
        const chatbotId = '{{ chatbot_id }}';
        let conversationHistory = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadChatbotInfo();
            loadConversationHistory();
            document.getElementById('chatInput').focus();
        });

        // チャットボット情報読み込み
        async function loadChatbotInfo() {
            try {
                const response = await fetch(`/api/chatbots/${chatbotId}`);
                if (response.ok) {
                    const chatbot = await response.json();
                    document.getElementById('chatbotInfo').textContent = 
                        `${chatbot.name} | RAG: ${chatbot.rag_configured ? '有効' : '無効'}`;
                } else {
                    document.getElementById('chatbotInfo').textContent = 'チャットボット情報の読み込みに失敗しました';
                }
            } catch (error) {
                console.error('チャットボット情報の読み込みエラー:', error);
                document.getElementById('chatbotInfo').textContent = 'エラーが発生しました';
            }
        }

        // 会話履歴読み込み
        async function loadConversationHistory() {
            try {
                const response = await fetch(`/api/chat/${chatbotId}/history`);
                if (response.ok) {
                    const historyData = await response.json();
                    console.log('History data received:', historyData);
                    
                    // historyDataは { messages: [...], total_messages: ..., ... } の形式
                    const messages = historyData.messages || [];
                    
                    if (messages.length > 0) {
                        document.getElementById('welcomeMessage').style.display = 'none';
                        messages.forEach(message => {
                            displayMessage(message.content, message.role, message.rag_sources, false);
                        });
                        scrollToBottom();
                    }
                    
                    // conversationHistoryにはmessages配列のみを設定
                    conversationHistory = messages;
                    console.log('Conversation history set:', conversationHistory);
                }
            } catch (error) {
                console.error('会話履歴の読み込みエラー:', error);
            }
        }

        // キーボードイベント処理
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // テキストエリアの自動リサイズ
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // メッセージ送信
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();

            if (!message) return;

            // UI更新
            input.value = '';
            input.style.height = 'auto';
            sendButton.disabled = true;
            document.getElementById('welcomeMessage').style.display = 'none';

            // ユーザーメッセージ表示
            displayMessage(message, 'user');
            
            // タイピングインジケーター表示
            showTypingIndicator();

            try {
                const response = await fetch(`/api/chat/${chatbotId}/message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory
                    })
                });

                hideTypingIndicator();

                if (response.ok) {
                    const result = await response.json();
                    
                    // アシスタントの応答表示
                    displayMessage(result.response, 'assistant', result.rag_sources);
                    
                    // 会話履歴に追加
                    conversationHistory.push(
                        { role: 'user', content: message },
                        { role: 'assistant', content: result.response, rag_sources: result.rag_sources }
                    );
                } else {
                    const error = await response.json();
                    displayErrorMessage(error.detail || 'エラーが発生しました');
                }
            } catch (error) {
                hideTypingIndicator();
                console.error('メッセージ送信エラー:', error);
                displayErrorMessage('通信エラーが発生しました');
            } finally {
                sendButton.disabled = false;
                input.focus();
            }
        }

        // メッセージ表示
        function displayMessage(content, role, ragSources = null, scroll = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let messageHTML = `<div class="message-content">${formatMessage(content)}</div>`;
            
            // RAGソース情報を表示
            if (ragSources && ragSources.length > 0) {
                messageHTML += `
                    <div class="card bg-light mt-1">
                        <strong>参考文書:</strong>
                        <div class="flex-center gap-1 mt-1">
                            ${ragSources.map(source => `<span class="btn btn-small text-primary">${source}</span>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            messageHTML += `<div class="message-metadata">${new Date().toLocaleTimeString('ja-JP')}</div>`;
            messageDiv.innerHTML = messageHTML;

            messagesContainer.appendChild(messageDiv);

            if (scroll) {
                scrollToBottom();
            }
        }

        // エラーメッセージ表示
        function displayErrorMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'notification error';
            errorDiv.innerHTML = `<strong>エラー:</strong> ${message}`;
            messagesContainer.appendChild(errorDiv);
            scrollToBottom();
            
            // 5秒後に自動で削除
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // タイピングインジケーター表示/非表示
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const indicatorDiv = document.createElement('div');
            indicatorDiv.id = 'typingIndicator';
            indicatorDiv.className = 'message assistant';
            indicatorDiv.innerHTML = '<div class="loading-container"><div class="spinner"></div><p>回答を生成中...</p></div>';
            messagesContainer.appendChild(indicatorDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // メッセージフォーマット
        function formatMessage(message) {
            // 簡単なマークダウン風フォーマット
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        // 最下部へスクロール
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 会話クリア（開発用）
        function clearConversation() {
            if (confirm('会話履歴をクリアしますか？')) {
                conversationHistory = [];
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('welcomeMessage').style.display = 'block';
                document.getElementById('chatMessages').appendChild(document.getElementById('welcomeMessage'));
            }
        }
    </script>
</body>
</html>