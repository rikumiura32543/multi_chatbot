<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - RAGチャットボット</title>
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>RAG設定</h1>
            <div class="header-actions">
                <button onclick="location.href='/'" class="btn">
                    ホーム
                </button>
                <button onclick="location.href='/chat/{{ chatbot_id }}'" class="btn btn-primary">
                    チャット開始
                </button>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- チャットボット情報 -->
        <div class="card">
            <h2>チャットボット情報</h2>
            <div id="chatbotInfo">
                <p>チャットボットID: <strong>{{ chatbot_id }}</strong></p>
                <p>読み込み中...</p>
            </div>
        </div>

        <!-- 統計情報 -->
        <div class="card">
            <h2>RAG統計</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalChunks">-</div>
                    <div>文書チャンク数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueFiles">-</div>
                    <div>処理済みファイル数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="vectorStoreSize">-</div>
                    <div>ベクトルストアサイズ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="rebuildStatus">待機中</div>
                    <div>再構築状況</div>
                </div>
            </div>
        </div>

        <!-- フォルダ指定RAG設定 -->
        <div class="card">
            <h2>フォルダ指定RAG設定</h2>
            <p>フォルダを選択して、その中の文書ファイル（PDF、Word、Markdown、テキスト）をまとめてRAGに設定できます。</p>
            
            <div class="folder-selection-area">
                <button onclick="selectLocalFolders()" class="btn btn-primary btn-full-width" id="selectFoldersBtn">
                    📁 フォルダを選択
                </button>
                
                <div class="browser-compatibility-note" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 4px; font-size: 0.9em;">
                    <strong>💡 ヒント:</strong> この機能はChrome、Edge、Safari（最新版）で利用できます。
                    ブラウザがフォルダ選択をサポートしていない場合は、従来のフォルダブラウザーが表示されます。
                </div>
                
                <div class="selected-folders" id="selectedFolders" style="display: none;">
                    <h3>選択したフォルダ:</h3>
                    <div id="selectedFolderList"></div>
                    <button onclick="clearSelectedFolders()" class="btn" style="margin-top: 10px;">
                        選択をクリア
                    </button>
                </div>
                
                <div class="folder-setup-controls" style="margin-top: 15px;">
                    <button onclick="setupRagFromFolders()" id="folderSetupBtn" class="btn btn-primary btn-full-width" disabled>
                        選択したフォルダからRAGを設定
                    </button>
                    <div class="progress-info" id="folderProgressInfo" style="display: none;">
                        <p>処理中... しばらくお待ちください</p>
                    </div>
                </div>
            </div>
            
            <!-- フォールバック: 従来のブラウザー -->
            <div class="folder-browser" id="folderBrowser" style="display: none;">
                <h3>フォルダブラウザー（フォールバック）</h3>
                <div class="folder-path-display">
                    <strong>現在のパス:</strong> <span id="currentPath">/Users</span>
                    <button onclick="goToParentFolder()" id="parentBtn" class="btn" style="margin-left: 10px;">
                        上位フォルダ
                    </button>
                </div>
                
                <div class="folder-list" id="folderList">
                    <p>フォルダ一覧を読み込み中...</p>
                </div>
            </div>
        </div>

        <!-- ファイルアップロード -->
        <div class="card">
            <h2>個別ファイルアップロード</h2>
            <p>PDF、Word、Markdown、テキストファイルを個別にアップロードして、RAG用のベクトルストアに追加できます。</p>
            
            <div class="upload-area" id="uploadArea">
                <div>
                    <p style="font-size: 1.2em; margin-bottom: 10px;">ファイルをドラッグ&ドロップまたはクリックして選択</p>
                    <p style="color: #666;">対応形式: PDF, DOCX, MD, TXT (最大10MB)</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.md,.txt" style="display: none;">
                </div>
            </div>

            <div class="progress-bar" id="uploadProgress" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="file-list" id="fileList" style="display: none;">
                <h3>アップロードしたファイル:</h3>
                <div id="uploadedFiles"></div>
            </div>
        </div>

        <!-- RAG設定 -->
        <div class="card">
            <h2>RAG設定</h2>
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label" for="chunkSize">チャンクサイズ</label>
                    <input class="form-input" type="number" id="chunkSize" value="1000" min="100" max="2000">
                    <span class="form-help">文書を分割する際のチャンクサイズ（文字数）</span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="chunkOverlap">チャンクオーバーラップ</label>
                    <input class="form-input" type="number" id="chunkOverlap" value="200" min="0" max="500">
                    <span class="form-help">隣接チャンク間の重複文字数</span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="searchK">検索結果数</label>
                    <input class="form-input" type="number" id="searchK" value="3" min="1" max="10">
                    <span class="form-help">関連文書の検索結果数</span>
                </div>
            </div>
            <button onclick="saveRagSettings()" class="btn btn-primary btn-full-width">
                設定保存
            </button>
        </div>

        <!-- ベクトルストア管理 -->
        <div class="card">
            <h2>ベクトルストア管理</h2>
            <div class="grid grid-3 gap-2">
                <button onclick="rebuildVectorStore()" class="btn btn-primary btn-full-width">
                    ベクトルストア再構築
                </button>
                <button onclick="clearVectorStore()" class="btn btn-danger btn-full-width">
                    ベクトルストアクリア
                </button>
                <button onclick="testSearch()" class="btn btn-full-width">
                    検索テスト
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatbotId = '{{ chatbot_id }}';
        let uploadedFiles = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadChatbotInfo();
            loadRagStats();
            setupFileUpload();
            initializeFolderSelection();
        });
        
        // フォルダ選択用変数
        let currentFolderPath = '/Users';
        let selectedFolderPaths = [];
        let selectedFolderHandles = []; // File System Access API用

        // チャットボット情報読み込み
        async function loadChatbotInfo() {
            try {
                const response = await fetch(`/api/chatbots/${chatbotId}`);
                if (response.ok) {
                    const chatbot = await response.json();
                    document.getElementById('chatbotInfo').innerHTML = `
                        <p>チャットボットID: <strong>${chatbot.id}</strong></p>
                        <p>名前: <strong>${chatbot.name}</strong></p>
                        <p>説明: ${chatbot.description || 'なし'}</p>
                        <p>作成日時: ${new Date(chatbot.created_at).toLocaleString('ja-JP')}</p>
                        <p>RAG設定: ${chatbot.rag_configured ? '✅ 完了' : '⚠️ 未設定'}</p>
                    `;
                }
            } catch (error) {
                console.error('チャットボット情報の読み込みエラー:', error);
            }
        }

        // RAG統計読み込み
        async function loadRagStats() {
            try {
                const response = await fetch(`/api/rag/${chatbotId}/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalChunks').textContent = stats.total_chunks || 0;
                    document.getElementById('uniqueFiles').textContent = stats.unique_files || 0;
                    document.getElementById('vectorStoreSize').textContent = formatFileSize(stats.vector_store_size || 0);
                    // 再構築状況表示
                    updateRebuildStatus(stats.is_rebuilding || false);
                }
            } catch (error) {
                console.error('RAG統計の読み込みエラー:', error);
                document.getElementById('rebuildStatus').textContent = 'エラー';
                document.getElementById('rebuildStatus').className = 'stat-number error';
            }
        }

        // ファイルアップロード設定
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        }

        // ファイルアップロード処理
        async function uploadFiles(files) {
            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`/api/rag/${chatbotId}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        uploadedFiles.push({name: file.name, size: file.size, status: 'success'});
                        showNotification(`${file.name} をアップロードしました`, 'success');
                    } else {
                        showNotification(`${file.name} のアップロードに失敗しました`, 'error');
                    }
                } catch (error) {
                    console.error('アップロードエラー:', error);
                    showNotification(`❌ ${file.name} のアップロードに失敗しました`, 'error');
                }

                // プログレスバー更新
                const progress = ((i + 1) / files.length) * 100;
                progressFill.style.width = progress + '%';
            }

            // アップロード完了後の処理
            setTimeout(() => {
                progressBar.style.display = 'none';
                loadRagStats();
                displayUploadedFiles();
            }, 1000);
        }

        // アップロードしたファイル表示
        function displayUploadedFiles() {
            const fileList = document.getElementById('fileList');
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            
            if (uploadedFiles.length > 0) {
                fileList.style.display = 'block';
                uploadedFilesDiv.innerHTML = uploadedFiles.map(file => `
                    <div class="file-item">
                        <span>${file.name}</span>
                        <span>${formatFileSize(file.size)}</span>
                    </div>
                `).join('');
            }
        }

        // RAG設定保存
        async function saveRagSettings() {
            const settings = {
                chunk_size: parseInt(document.getElementById('chunkSize').value),
                chunk_overlap: parseInt(document.getElementById('chunkOverlap').value),
                search_k: parseInt(document.getElementById('searchK').value)
            };

            try {
                const response = await fetch(`/api/rag/${chatbotId}/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showNotification('RAG設定を保存しました', 'success');
                } else {
                    showNotification('RAG設定の保存に失敗しました', 'error');
                }
            } catch (error) {
                console.error('設定保存エラー:', error);
                showNotification('❌ RAG設定の保存に失敗しました', 'error');
            }
        }

        // 再構築状況更新
        function updateRebuildStatus(isRebuilding) {
            const statusElement = document.getElementById('rebuildStatus');
            if (isRebuilding) {
                statusElement.textContent = '再構築中...';
                statusElement.className = 'stat-number rebuilding';
                // 3秒後に再チェック
                setTimeout(() => loadRagStats(), 3000);
            } else {
                statusElement.textContent = '完了';
                statusElement.className = 'stat-number';
            }
        }

        // ベクトルストア再構築
        async function rebuildVectorStore() {
            if (!confirm('ベクトルストアを再構築しますか？この処理には時間がかかる場合があります。')) {
                return;
            }

            // 再構築状況を即座に更新
            updateRebuildStatus(true);

            try {
                const response = await fetch(`/api/rag/${chatbotId}/rebuild`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('ベクトルストアの再構築を開始しました', 'success');
                    // 定期的に状況をチェック
                    monitorRebuildProgress();
                } else {
                    showNotification('ベクトルストアの再構築に失敗しました', 'error');
                    updateRebuildStatus(false);
                }
            } catch (error) {
                console.error('再構築エラー:', error);
                showNotification('❌ ベクトルストアの再構築に失敗しました', 'error');
                updateRebuildStatus(false);
            }
        }

        // 再構築進行状況監視
        async function monitorRebuildProgress() {
            let attempts = 0;
            const maxAttempts = 20; // 最大60秒間監視

            const checkProgress = async () => {
                try {
                    const response = await fetch(`/api/rag/${chatbotId}/stats`);
                    if (response.ok) {
                        const stats = await response.json();
                        if (!stats.is_rebuilding) {
                            // 再構築完了
                            updateRebuildStatus(false);
                            loadRagStats();
                            showNotification('ベクトルストア再構築が完了しました', 'success');
                            return;
                        }
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkProgress, 3000); // 3秒後に再チェック
                    } else {
                        updateRebuildStatus(false);
                        showNotification('再構築の完了確認がタイムアウトしました', 'warning');
                    }
                } catch (error) {
                    console.error('再構築進行状況確認エラー:', error);
                    updateRebuildStatus(false);
                }
            };

            setTimeout(checkProgress, 3000); // 最初のチェックは3秒後
        }

        // ベクトルストアクリア
        async function clearVectorStore() {
            if (!confirm('ベクトルストアをクリアしますか？この操作は元に戻せません。')) {
                return;
            }

            try {
                const response = await fetch(`/api/rag/${chatbotId}/clear`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('ベクトルストアをクリアしました', 'success');
                    loadRagStats();
                    uploadedFiles = [];
                    document.getElementById('fileList').style.display = 'none';
                } else {
                    showNotification('ベクトルストアのクリアに失敗しました', 'error');
                }
            } catch (error) {
                console.error('クリアエラー:', error);
                showNotification('❌ ベクトルストアのクリアに失敗しました', 'error');
            }
        }

        // 検索テスト
        async function testSearch() {
            const query = prompt('検索テスト用のクエリを入力してください:');
            if (!query) return;

            try {
                const response = await fetch(`/api/rag/${chatbotId}/search`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, k: 3})
                });

                if (response.ok) {
                    const results = await response.json();
                    alert(`検索結果: ${results.length}件の文書が見つかりました`);
                } else {
                    showNotification('検索テストに失敗しました', 'error');
                }
            } catch (error) {
                console.error('検索テストエラー:', error);
                showNotification('❌ 検索テストに失敗しました', 'error');
            }
        }

        // ユーティリティ関数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // === ネイティブフォルダ選択機能 ===

        // フォルダ選択機能の初期化
        function initializeFolderSelection() {
            // File System Access API対応チェック
            if ('showDirectoryPicker' in window) {
                console.log('File System Access API サポート: 利用可能');
                // ネイティブフォルダ選択を使用
            } else {
                console.log('File System Access API サポート: 利用不可 - フォールバックモードに切り替え');
                // フォールバックモードを表示
                document.getElementById('folderBrowser').style.display = 'block';
                loadFolderList();
            }
        }

        // ローカルフォルダ選択（File System Access API使用）
        async function selectLocalFolders() {
            if (!('showDirectoryPicker' in window)) {
                showNotification('お使いのブラウザはフォルダ選択をサポートしていません。下のフォルダブラウザーをご利用ください。', 'error');
                document.getElementById('folderBrowser').style.display = 'block';
                loadFolderList();
                return;
            }

            try {
                // ディレクトリピッカーを表示
                const directoryHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    startIn: 'documents'
                });

                // 既に選択済みかチェック
                const folderPath = directoryHandle.name; // 実際のパスは取得できないため名前を使用
                const displayPath = `選択したフォルダ: ${directoryHandle.name}`;

                if (!selectedFolderHandles.find(handle => handle.name === directoryHandle.name)) {
                    selectedFolderHandles.push(directoryHandle);
                    selectedFolderPaths.push(displayPath);

                    updateSelectedFoldersDisplay();
                    updateFolderSetupButton();

                    showNotification(`フォルダ "${directoryHandle.name}" を選択しました`, 'success');
                } else {
                    showNotification(`フォルダ "${directoryHandle.name}" は既に選択済みです`, 'error');
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('フォルダ選択エラー:', error);
                    showNotification('フォルダ選択がキャンセルされました', 'error');
                }
            }
        }

        // 選択フォルダのクリア
        function clearSelectedFolders() {
            selectedFolderPaths = [];
            selectedFolderHandles = [];
            updateSelectedFoldersDisplay();
            updateFolderSetupButton();
            showNotification('選択したフォルダをクリアしました', 'success');
        }

        // File System Access API用のRAG設定実行
        async function setupRagFromLocalFolders() {
            if (selectedFolderHandles.length === 0) {
                showNotification('フォルダを選択してください', 'error');
                return;
            }

            if (!confirm(`${selectedFolderHandles.length}個のフォルダからRAGを設定しますか？既存のRAG設定は上書きされます。`)) {
                return;
            }

            const setupBtn = document.getElementById('folderSetupBtn');
            const progressInfo = document.getElementById('folderProgressInfo');
            
            // UI更新
            setupBtn.disabled = true;
            setupBtn.textContent = '処理中...';
            progressInfo.style.display = 'block';

            try {
                const chunkSize = parseInt(document.getElementById('chunkSize').value) || 1000;
                const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value) || 200;

                // フォルダ内のファイルを収集
                const allFiles = [];
                for (const dirHandle of selectedFolderHandles) {
                    const folderFiles = await collectFilesFromDirectory(dirHandle);
                    allFiles.push(...folderFiles);
                }

                if (allFiles.length === 0) {
                    showNotification('選択したフォルダに対応ファイルが見つかりませんでした', 'error');
                    return;
                }

                // ファイルをFormDataとして準備
                const formData = new FormData();
                formData.append('chunk_size', chunkSize.toString());
                formData.append('chunk_overlap', chunkOverlap.toString());

                for (const file of allFiles) {
                    formData.append('files', file);
                }

                // バッチアップロード用の新しいAPIエンドポイントを呼び出し
                const response = await fetch(`/api/rag/${chatbotId}/upload-batch`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(
                        `RAG設定が完了しました！処理したファイル: ${result.processed_files}個、チャンク: ${result.total_chunks}個`, 
                        'success'
                    );
                    
                    // 統計情報更新
                    loadRagStats();
                    loadChatbotInfo();
                    
                } else {
                    const error = await response.json();
                    showNotification(`RAG設定に失敗しました: ${error.detail}`, 'error');
                }

            } catch (error) {
                console.error('ローカルフォルダRAG設定エラー:', error);
                showNotification('RAG設定に失敗しました', 'error');
            } finally {
                // UI復元
                setupBtn.disabled = false;
                updateFolderSetupButton();
                progressInfo.style.display = 'none';
            }
        }

        // ディレクトリから対応ファイルを収集
        async function collectFilesFromDirectory(dirHandle) {
            const supportedExtensions = ['.pdf', '.docx', '.md', '.txt'];
            const files = [];

            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                        
                        if (supportedExtensions.includes(extension)) {
                            files.push(file);
                        }
                    }
                    // サブフォルダは処理しない（要件通り）
                }
            } catch (error) {
                console.error('ディレクトリ読み込みエラー:', error);
            }

            return files;
        }

        // === フォールバック: 従来のフォルダ選択機能 ===

        // フォルダ一覧読み込み
        async function loadFolderList(path = currentFolderPath) {
            try {
                const response = await fetch(`/api/rag/${chatbotId}/available-folders?search_path=${encodeURIComponent(path)}`);
                if (response.ok) {
                    const data = await response.json();
                    currentFolderPath = data.current_path;
                    renderFolderList(data);
                } else {
                    showNotification('フォルダ一覧の読み込みに失敗しました', 'error');
                }
            } catch (error) {
                console.error('フォルダ一覧読み込みエラー:', error);
                showNotification('フォルダ一覧の読み込みに失敗しました', 'error');
            }
        }

        // フォルダ一覧表示
        function renderFolderList(data) {
            document.getElementById('currentPath').textContent = data.current_path;
            
            const parentBtn = document.getElementById('parentBtn');
            parentBtn.disabled = !data.parent_path;
            
            const folderList = document.getElementById('folderList');
            
            if (data.folders.length === 0) {
                folderList.innerHTML = '<p>フォルダが見つかりませんでした</p>';
                return;
            }
            
            folderList.innerHTML = data.folders.map(folder => `
                <div class="folder-item" data-path="${folder.path}">
                    <div class="folder-info">
                        <div class="folder-name">📁 ${folder.name}</div>
                        <div class="folder-stats">${folder.file_count}ファイル</div>
                    </div>
                    <div class="folder-actions">
                        <button onclick="navigateToFolder('${folder.path}')" class="btn" style="margin-right: 5px;">
                            開く
                        </button>
                        <button onclick="toggleFolderSelection('${folder.path}', '${folder.name}')" 
                                class="btn ${selectedFolderPaths.includes(folder.path) ? 'btn-primary' : ''}" 
                                id="select-${folder.path.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${selectedFolderPaths.includes(folder.path) ? '選択解除' : '選択'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 上位フォルダに移動
        function goToParentFolder() {
            const parentBtn = document.getElementById('parentBtn');
            if (parentBtn.disabled) return;
            
            const parentPath = currentFolderPath.split('/').slice(0, -1).join('/') || '/';
            loadFolderList(parentPath);
        }

        // フォルダに移動
        function navigateToFolder(folderPath) {
            loadFolderList(folderPath);
        }

        // フォルダ選択切り替え
        function toggleFolderSelection(folderPath, folderName) {
            const index = selectedFolderPaths.indexOf(folderPath);
            
            if (index === -1) {
                // 選択追加
                selectedFolderPaths.push(folderPath);
            } else {
                // 選択解除
                selectedFolderPaths.splice(index, 1);
            }
            
            updateSelectedFoldersDisplay();
            updateFolderSetupButton();
            
            // ボタンの表示更新
            renderFolderList({
                current_path: currentFolderPath,
                parent_path: currentFolderPath.split('/').slice(0, -1).join('/') || '/',
                folders: Array.from(document.querySelectorAll('.folder-item')).map(item => ({
                    path: item.dataset.path,
                    name: item.querySelector('.folder-name').textContent.replace('📁 ', ''),
                    file_count: parseInt(item.querySelector('.folder-stats').textContent.replace('ファイル', ''))
                }))
            });
        }

        // 選択したフォルダ表示更新
        function updateSelectedFoldersDisplay() {
            const selectedFoldersDiv = document.getElementById('selectedFolders');
            const selectedFolderList = document.getElementById('selectedFolderList');
            
            if (selectedFolderPaths.length === 0) {
                selectedFoldersDiv.style.display = 'none';
                return;
            }
            
            selectedFoldersDiv.style.display = 'block';
            selectedFolderList.innerHTML = selectedFolderPaths.map(path => `
                <div class="selected-folder-item" style="display: flex; justify-content: space-between; align-items: center; padding: 5px; border: 1px solid #ddd; margin: 2px 0;">
                    <span>📁 ${path}</span>
                    <button onclick="toggleFolderSelection('${path}', '')" class="btn btn-danger" style="padding: 2px 8px;">
                        削除
                    </button>
                </div>
            `).join('');
        }

        // フォルダ設定ボタン状態更新
        function updateFolderSetupButton() {
            const setupBtn = document.getElementById('folderSetupBtn');
            
            // ネイティブフォルダ選択とフォールバック両方をチェック
            const totalSelected = selectedFolderHandles.length + selectedFolderPaths.length;
            const nativeFolders = selectedFolderHandles.length;
            const fallbackFolders = selectedFolderPaths.length;
            
            setupBtn.disabled = totalSelected === 0;
            
            if (totalSelected === 0) {
                setupBtn.textContent = '選択したフォルダからRAGを設定';
            } else if (nativeFolders > 0) {
                setupBtn.textContent = `選択した${nativeFolders}個のフォルダからRAGを設定`;
            } else {
                setupBtn.textContent = `選択した${fallbackFolders}個のフォルダからRAGを設定`;
            }
        }

        // フォルダからRAG設定実行（ネイティブ or フォールバック自動判定）
        async function setupRagFromFolders() {
            // ネイティブフォルダ選択が利用可能で、ファイルハンドルがある場合
            if (selectedFolderHandles.length > 0) {
                await setupRagFromLocalFolders();
                return;
            }
            
            // フォールバック: 従来のパス指定方式
            if (selectedFolderPaths.length === 0) {
                showNotification('フォルダを選択してください', 'error');
                return;
            }
            
            if (!confirm(`${selectedFolderPaths.length}個のフォルダからRAGを設定しますか？既存のRAG設定は上書きされます。`)) {
                return;
            }
            
            const setupBtn = document.getElementById('folderSetupBtn');
            const progressInfo = document.getElementById('folderProgressInfo');
            
            // UI更新
            setupBtn.disabled = true;
            setupBtn.textContent = '処理中...';
            progressInfo.style.display = 'block';
            
            try {
                const chunkSize = parseInt(document.getElementById('chunkSize').value) || 1000;
                const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value) || 200;
                
                const response = await fetch(`/api/rag/${chatbotId}/setup-from-folders`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        folder_paths: selectedFolderPaths,
                        chunk_size: chunkSize,
                        chunk_overlap: chunkOverlap
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(
                        `RAG設定が完了しました！処理したフォルダ: ${result.processed_folders}個、ファイル: ${result.processed_files}個、チャンク: ${result.total_chunks}個`, 
                        'success'
                    );
                    
                    // 統計情報更新
                    loadRagStats();
                    loadChatbotInfo();
                    
                } else {
                    const error = await response.json();
                    showNotification(`RAG設定に失敗しました: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('フォルダRAG設定エラー:', error);
                showNotification('RAG設定に失敗しました', 'error');
            } finally {
                // UI復元
                setupBtn.disabled = false;
                updateFolderSetupButton();
                progressInfo.style.display = 'none';
            }
        }
    </script>
</body>
</html>