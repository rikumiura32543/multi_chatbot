<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - RAGãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</title>
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>RAGè¨­å®š</h1>
            <div class="header-actions">
                <button onclick="location.href='/'" class="btn">
                    ãƒ›ãƒ¼ãƒ 
                </button>
                <button onclick="location.href='/chat/{{ chatbot_id }}'" class="btn btn-primary">
                    ãƒãƒ£ãƒƒãƒˆé–‹å§‹
                </button>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæƒ…å ± -->
        <div class="card">
            <h2>ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæƒ…å ±</h2>
            <div id="chatbotInfo">
                <p>ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆID: <strong>{{ chatbot_id }}</strong></p>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="card">
            <h2>RAGçµ±è¨ˆ</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalChunks">-</div>
                    <div>æ–‡æ›¸ãƒãƒ£ãƒ³ã‚¯æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueFiles">-</div>
                    <div>å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="vectorStoreSize">-</div>
                    <div>ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‚µã‚¤ã‚º</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="rebuildStatus">å¾…æ©Ÿä¸­</div>
                    <div>å†æ§‹ç¯‰çŠ¶æ³</div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šRAGè¨­å®š -->
        <div class="card">
            <h2>ãƒ•ã‚©ãƒ«ãƒ€æŒ‡å®šRAGè¨­å®š</h2>
            <p>ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ã€ãã®ä¸­ã®æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPDFã€Wordã€Markdownã€ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’ã¾ã¨ã‚ã¦RAGã«è¨­å®šã§ãã¾ã™ã€‚</p>
            
            <div class="folder-selection-area">
                <button onclick="selectLocalFolders()" class="btn btn-primary btn-full-width" id="selectFoldersBtn">
                    ğŸ“ ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
                </button>
                
                <div class="browser-compatibility-note" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 4px; font-size: 0.9em;">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ã“ã®æ©Ÿèƒ½ã¯Chromeã€Edgeã€Safariï¼ˆæœ€æ–°ç‰ˆï¼‰ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
                    ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„å ´åˆã¯ã€å¾“æ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
                
                <div class="selected-folders" id="selectedFolders" style="display: none;">
                    <h3>é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€:</h3>
                    <div id="selectedFolderList"></div>
                    <button onclick="clearSelectedFolders()" class="btn" style="margin-top: 10px;">
                        é¸æŠã‚’ã‚¯ãƒªã‚¢
                    </button>
                </div>
                
                <div class="folder-setup-controls" style="margin-top: 15px;">
                    <button onclick="setupRagFromFolders()" id="folderSetupBtn" class="btn btn-primary btn-full-width" disabled>
                        é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGã‚’è¨­å®š
                    </button>
                    <div class="progress-info" id="folderProgressInfo" style="display: none;">
                        <p>å‡¦ç†ä¸­... ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</p>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ -->
            <div class="folder-browser" id="folderBrowser" style="display: none;">
                <h3>ãƒ•ã‚©ãƒ«ãƒ€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰</h3>
                <div class="folder-path-display">
                    <strong>ç¾åœ¨ã®ãƒ‘ã‚¹:</strong> <span id="currentPath">/Users</span>
                    <button onclick="goToParentFolder()" id="parentBtn" class="btn" style="margin-left: 10px;">
                        ä¸Šä½ãƒ•ã‚©ãƒ«ãƒ€
                    </button>
                </div>
                
                <div class="folder-list" id="folderList">
                    <p>ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
        <div class="card">
            <h2>å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <p>PDFã€Wordã€Markdownã€ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å€‹åˆ¥ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€RAGç”¨ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã«è¿½åŠ ã§ãã¾ã™ã€‚</p>
            
            <div class="upload-area" id="uploadArea">
                <div>
                    <p style="font-size: 1.2em; margin-bottom: 10px;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <p style="color: #666;">å¯¾å¿œå½¢å¼: PDF, DOCX, MD, TXT (æœ€å¤§10MB)</p>
                    <input type="file" id="fileInput" multiple accept=".pdf,.docx,.md,.txt" style="display: none;">
                </div>
            </div>

            <div class="progress-bar" id="uploadProgress" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="file-list" id="fileList" style="display: none;">
                <h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:</h3>
                <div id="uploadedFiles"></div>
            </div>
        </div>

        <!-- RAGè¨­å®š -->
        <div class="card">
            <h2>RAGè¨­å®š</h2>
            <div class="grid grid-3">
                <div class="form-group">
                    <label class="form-label" for="chunkSize">ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º</label>
                    <input class="form-input" type="number" id="chunkSize" value="1000" min="100" max="2000">
                    <span class="form-help">æ–‡æ›¸ã‚’åˆ†å‰²ã™ã‚‹éš›ã®ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºï¼ˆæ–‡å­—æ•°ï¼‰</span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="chunkOverlap">ãƒãƒ£ãƒ³ã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ãƒƒãƒ—</label>
                    <input class="form-input" type="number" id="chunkOverlap" value="200" min="0" max="500">
                    <span class="form-help">éš£æ¥ãƒãƒ£ãƒ³ã‚¯é–“ã®é‡è¤‡æ–‡å­—æ•°</span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="searchK">æ¤œç´¢çµæœæ•°</label>
                    <input class="form-input" type="number" id="searchK" value="3" min="1" max="10">
                    <span class="form-help">é–¢é€£æ–‡æ›¸ã®æ¤œç´¢çµæœæ•°</span>
                </div>
            </div>
            <button onclick="saveRagSettings()" class="btn btn-primary btn-full-width">
                è¨­å®šä¿å­˜
            </button>
        </div>

        <!-- ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ç®¡ç† -->
        <div class="card">
            <h2>ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ç®¡ç†</h2>
            <div class="grid grid-3 gap-2">
                <button onclick="rebuildVectorStore()" class="btn btn-primary btn-full-width">
                    ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢å†æ§‹ç¯‰
                </button>
                <button onclick="clearVectorStore()" class="btn btn-danger btn-full-width">
                    ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‚¯ãƒªã‚¢
                </button>
                <button onclick="testSearch()" class="btn btn-full-width">
                    æ¤œç´¢ãƒ†ã‚¹ãƒˆ
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatbotId = '{{ chatbot_id }}';
        let uploadedFiles = [];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadChatbotInfo();
            loadRagStats();
            setupFileUpload();
            initializeFolderSelection();
        });
        
        // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠç”¨å¤‰æ•°
        let currentFolderPath = '/Users';
        let selectedFolderPaths = [];
        let selectedFolderHandles = []; // File System Access APIç”¨

        // ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæƒ…å ±èª­ã¿è¾¼ã¿
        async function loadChatbotInfo() {
            try {
                const response = await fetch(`/api/chatbots/${chatbotId}`);
                if (response.ok) {
                    const chatbot = await response.json();
                    document.getElementById('chatbotInfo').innerHTML = `
                        <p>ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆID: <strong>${chatbot.id}</strong></p>
                        <p>åå‰: <strong>${chatbot.name}</strong></p>
                        <p>èª¬æ˜: ${chatbot.description || 'ãªã—'}</p>
                        <p>ä½œæˆæ—¥æ™‚: ${new Date(chatbot.created_at).toLocaleString('ja-JP')}</p>
                        <p>RAGè¨­å®š: ${chatbot.rag_configured ? 'âœ… å®Œäº†' : 'âš ï¸ æœªè¨­å®š'}</p>
                    `;
                }
            } catch (error) {
                console.error('ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // RAGçµ±è¨ˆèª­ã¿è¾¼ã¿
        async function loadRagStats() {
            try {
                const response = await fetch(`/api/rag/${chatbotId}/stats`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalChunks').textContent = stats.total_chunks || 0;
                    document.getElementById('uniqueFiles').textContent = stats.unique_files || 0;
                    document.getElementById('vectorStoreSize').textContent = formatFileSize(stats.vector_store_size || 0);
                    // å†æ§‹ç¯‰çŠ¶æ³è¡¨ç¤º
                    updateRebuildStatus(stats.is_rebuilding || false);
                }
            } catch (error) {
                console.error('RAGçµ±è¨ˆã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('rebuildStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
                document.getElementById('rebuildStatus').className = 'stat-number error';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¨­å®š
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            uploadFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        async function uploadFiles(files) {
            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`/api/rag/${chatbotId}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        uploadedFiles.push({name: file.name, size: file.size, status: 'success'});
                        showNotification(`${file.name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
                    } else {
                        showNotification(`${file.name} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`, 'error');
                    }
                } catch (error) {
                    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification(`âŒ ${file.name} ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`, 'error');
                }

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                const progress = ((i + 1) / files.length) * 100;
                progressFill.style.width = progress + '%';
            }

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã®å‡¦ç†
            setTimeout(() => {
                progressBar.style.display = 'none';
                loadRagStats();
                displayUploadedFiles();
            }, 1000);
        }

        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
        function displayUploadedFiles() {
            const fileList = document.getElementById('fileList');
            const uploadedFilesDiv = document.getElementById('uploadedFiles');
            
            if (uploadedFiles.length > 0) {
                fileList.style.display = 'block';
                uploadedFilesDiv.innerHTML = uploadedFiles.map(file => `
                    <div class="file-item">
                        <span>${file.name}</span>
                        <span>${formatFileSize(file.size)}</span>
                    </div>
                `).join('');
            }
        }

        // RAGè¨­å®šä¿å­˜
        async function saveRagSettings() {
            const settings = {
                chunk_size: parseInt(document.getElementById('chunkSize').value),
                chunk_overlap: parseInt(document.getElementById('chunkOverlap').value),
                search_k: parseInt(document.getElementById('searchK').value)
            };

            try {
                const response = await fetch(`/api/rag/${chatbotId}/settings`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showNotification('RAGè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
                } else {
                    showNotification('RAGè¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('âŒ RAGè¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // å†æ§‹ç¯‰çŠ¶æ³æ›´æ–°
        function updateRebuildStatus(isRebuilding) {
            const statusElement = document.getElementById('rebuildStatus');
            if (isRebuilding) {
                statusElement.textContent = 'å†æ§‹ç¯‰ä¸­...';
                statusElement.className = 'stat-number rebuilding';
                // 3ç§’å¾Œã«å†ãƒã‚§ãƒƒã‚¯
                setTimeout(() => loadRagStats(), 3000);
            } else {
                statusElement.textContent = 'å®Œäº†';
                statusElement.className = 'stat-number';
            }
        }

        // ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢å†æ§‹ç¯‰
        async function rebuildVectorStore() {
            if (!confirm('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‚’å†æ§‹ç¯‰ã—ã¾ã™ã‹ï¼Ÿã“ã®å‡¦ç†ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚')) {
                return;
            }

            // å†æ§‹ç¯‰çŠ¶æ³ã‚’å³åº§ã«æ›´æ–°
            updateRebuildStatus(true);

            try {
                const response = await fetch(`/api/rag/${chatbotId}/rebuild`, {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®å†æ§‹ç¯‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
                    // å®šæœŸçš„ã«çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
                    monitorRebuildProgress();
                } else {
                    showNotification('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®å†æ§‹ç¯‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    updateRebuildStatus(false);
                }
            } catch (error) {
                console.error('å†æ§‹ç¯‰ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('âŒ ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®å†æ§‹ç¯‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                updateRebuildStatus(false);
            }
        }

        // å†æ§‹ç¯‰é€²è¡ŒçŠ¶æ³ç›£è¦–
        async function monitorRebuildProgress() {
            let attempts = 0;
            const maxAttempts = 20; // æœ€å¤§60ç§’é–“ç›£è¦–

            const checkProgress = async () => {
                try {
                    const response = await fetch(`/api/rag/${chatbotId}/stats`);
                    if (response.ok) {
                        const stats = await response.json();
                        if (!stats.is_rebuilding) {
                            // å†æ§‹ç¯‰å®Œäº†
                            updateRebuildStatus(false);
                            loadRagStats();
                            showNotification('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢å†æ§‹ç¯‰ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                            return;
                        }
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(checkProgress, 3000); // 3ç§’å¾Œã«å†ãƒã‚§ãƒƒã‚¯
                    } else {
                        updateRebuildStatus(false);
                        showNotification('å†æ§‹ç¯‰ã®å®Œäº†ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'warning');
                    }
                } catch (error) {
                    console.error('å†æ§‹ç¯‰é€²è¡ŒçŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                    updateRebuildStatus(false);
                }
            };

            setTimeout(checkProgress, 3000); // æœ€åˆã®ãƒã‚§ãƒƒã‚¯ã¯3ç§’å¾Œ
        }

        // ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‚¯ãƒªã‚¢
        async function clearVectorStore() {
            if (!confirm('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`/api/rag/${chatbotId}/clear`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                    loadRagStats();
                    uploadedFiles = [];
                    document.getElementById('fileList').style.display = 'none';
                } else {
                    showNotification('ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('âŒ ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // æ¤œç´¢ãƒ†ã‚¹ãƒˆ
        async function testSearch() {
            const query = prompt('æ¤œç´¢ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!query) return;

            try {
                const response = await fetch(`/api/rag/${chatbotId}/search`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({query: query, k: 3})
                });

                if (response.ok) {
                    const results = await response.json();
                    alert(`æ¤œç´¢çµæœ: ${results.length}ä»¶ã®æ–‡æ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                } else {
                    showNotification('æ¤œç´¢ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('æ¤œç´¢ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('âŒ æ¤œç´¢ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // === ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ©Ÿèƒ½ ===

        // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ©Ÿèƒ½ã®åˆæœŸåŒ–
        function initializeFolderSelection() {
            // File System Access APIå¯¾å¿œãƒã‚§ãƒƒã‚¯
            if ('showDirectoryPicker' in window) {
                console.log('File System Access API ã‚µãƒãƒ¼ãƒˆ: åˆ©ç”¨å¯èƒ½');
                // ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ä½¿ç”¨
            } else {
                console.log('File System Access API ã‚µãƒãƒ¼ãƒˆ: åˆ©ç”¨ä¸å¯ - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                document.getElementById('folderBrowser').style.display = 'block';
                loadFolderList();
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€é¸æŠï¼ˆFile System Access APIä½¿ç”¨ï¼‰
        async function selectLocalFolders() {
            if (!('showDirectoryPicker' in window)) {
                showNotification('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚ä¸‹ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚', 'error');
                document.getElementById('folderBrowser').style.display = 'block';
                loadFolderList();
                return;
            }

            try {
                // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ”ãƒƒã‚«ãƒ¼ã‚’è¡¨ç¤º
                const directoryHandle = await window.showDirectoryPicker({
                    mode: 'read',
                    startIn: 'documents'
                });

                // æ—¢ã«é¸æŠæ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
                const folderPath = directoryHandle.name; // å®Ÿéš›ã®ãƒ‘ã‚¹ã¯å–å¾—ã§ããªã„ãŸã‚åå‰ã‚’ä½¿ç”¨
                const displayPath = `é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€: ${directoryHandle.name}`;

                if (!selectedFolderHandles.find(handle => handle.name === directoryHandle.name)) {
                    selectedFolderHandles.push(directoryHandle);
                    selectedFolderPaths.push(displayPath);

                    updateSelectedFoldersDisplay();
                    updateFolderSetupButton();

                    showNotification(`ãƒ•ã‚©ãƒ«ãƒ€ "${directoryHandle.name}" ã‚’é¸æŠã—ã¾ã—ãŸ`, 'success');
                } else {
                    showNotification(`ãƒ•ã‚©ãƒ«ãƒ€ "${directoryHandle.name}" ã¯æ—¢ã«é¸æŠæ¸ˆã¿ã§ã™`, 'error');
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'error');
                }
            }
        }

        // é¸æŠãƒ•ã‚©ãƒ«ãƒ€ã®ã‚¯ãƒªã‚¢
        function clearSelectedFolders() {
            selectedFolderPaths = [];
            selectedFolderHandles = [];
            updateSelectedFoldersDisplay();
            updateFolderSetupButton();
            showNotification('é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // File System Access APIç”¨ã®RAGè¨­å®šå®Ÿè¡Œ
        async function setupRagFromLocalFolders() {
            if (selectedFolderHandles.length === 0) {
                showNotification('ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!confirm(`${selectedFolderHandles.length}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®RAGè¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            const setupBtn = document.getElementById('folderSetupBtn');
            const progressInfo = document.getElementById('folderProgressInfo');
            
            // UIæ›´æ–°
            setupBtn.disabled = true;
            setupBtn.textContent = 'å‡¦ç†ä¸­...';
            progressInfo.style.display = 'block';

            try {
                const chunkSize = parseInt(document.getElementById('chunkSize').value) || 1000;
                const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value) || 200;

                // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
                const allFiles = [];
                for (const dirHandle of selectedFolderHandles) {
                    const folderFiles = await collectFilesFromDirectory(dirHandle);
                    allFiles.push(...folderFiles);
                }

                if (allFiles.length === 0) {
                    showNotification('é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    return;
                }

                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’FormDataã¨ã—ã¦æº–å‚™
                const formData = new FormData();
                formData.append('chunk_size', chunkSize.toString());
                formData.append('chunk_overlap', chunkOverlap.toString());

                for (const file of allFiles) {
                    formData.append('files', file);
                }

                // ãƒãƒƒãƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®æ–°ã—ã„APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—
                const response = await fetch(`/api/rag/${chatbotId}/upload-batch`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification(
                        `RAGè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼å‡¦ç†ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«: ${result.processed_files}å€‹ã€ãƒãƒ£ãƒ³ã‚¯: ${result.total_chunks}å€‹`, 
                        'success'
                    );
                    
                    // çµ±è¨ˆæƒ…å ±æ›´æ–°
                    loadRagStats();
                    loadChatbotInfo();
                    
                } else {
                    const error = await response.json();
                    showNotification(`RAGè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.detail}`, 'error');
                }

            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ«ãƒ€RAGè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                showNotification('RAGè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                // UIå¾©å…ƒ
                setupBtn.disabled = false;
                updateFolderSetupButton();
                progressInfo.style.display = 'none';
            }
        }

        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å¯¾å¿œãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†
        async function collectFilesFromDirectory(dirHandle) {
            const supportedExtensions = ['.pdf', '.docx', '.md', '.txt'];
            const files = [];

            try {
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') {
                        const file = await entry.getFile();
                        const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                        
                        if (supportedExtensions.includes(extension)) {
                            files.push(file);
                        }
                    }
                    // ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã¯å‡¦ç†ã—ãªã„ï¼ˆè¦ä»¶é€šã‚Šï¼‰
                }
            } catch (error) {
                console.error('ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }

            return files;
        }

        // === ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒ•ã‚©ãƒ«ãƒ€é¸æŠæ©Ÿèƒ½ ===

        // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadFolderList(path = currentFolderPath) {
            try {
                const response = await fetch(`/api/rag/${chatbotId}/available-folders?search_path=${encodeURIComponent(path)}`);
                if (response.ok) {
                    const data = await response.json();
                    currentFolderPath = data.current_path;
                    renderFolderList(data);
                } else {
                    showNotification('ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§è¡¨ç¤º
        function renderFolderList(data) {
            document.getElementById('currentPath').textContent = data.current_path;
            
            const parentBtn = document.getElementById('parentBtn');
            parentBtn.disabled = !data.parent_path;
            
            const folderList = document.getElementById('folderList');
            
            if (data.folders.length === 0) {
                folderList.innerHTML = '<p>ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }
            
            folderList.innerHTML = data.folders.map(folder => `
                <div class="folder-item" data-path="${folder.path}">
                    <div class="folder-info">
                        <div class="folder-name">ğŸ“ ${folder.name}</div>
                        <div class="folder-stats">${folder.file_count}ãƒ•ã‚¡ã‚¤ãƒ«</div>
                    </div>
                    <div class="folder-actions">
                        <button onclick="navigateToFolder('${folder.path}')" class="btn" style="margin-right: 5px;">
                            é–‹ã
                        </button>
                        <button onclick="toggleFolderSelection('${folder.path}', '${folder.name}')" 
                                class="btn ${selectedFolderPaths.includes(folder.path) ? 'btn-primary' : ''}" 
                                id="select-${folder.path.replace(/[^a-zA-Z0-9]/g, '_')}">
                            ${selectedFolderPaths.includes(folder.path) ? 'é¸æŠè§£é™¤' : 'é¸æŠ'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ä¸Šä½ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
        function goToParentFolder() {
            const parentBtn = document.getElementById('parentBtn');
            if (parentBtn.disabled) return;
            
            const parentPath = currentFolderPath.split('/').slice(0, -1).join('/') || '/';
            loadFolderList(parentPath);
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
        function navigateToFolder(folderPath) {
            loadFolderList(folderPath);
        }

        // ãƒ•ã‚©ãƒ«ãƒ€é¸æŠåˆ‡ã‚Šæ›¿ãˆ
        function toggleFolderSelection(folderPath, folderName) {
            const index = selectedFolderPaths.indexOf(folderPath);
            
            if (index === -1) {
                // é¸æŠè¿½åŠ 
                selectedFolderPaths.push(folderPath);
            } else {
                // é¸æŠè§£é™¤
                selectedFolderPaths.splice(index, 1);
            }
            
            updateSelectedFoldersDisplay();
            updateFolderSetupButton();
            
            // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ›´æ–°
            renderFolderList({
                current_path: currentFolderPath,
                parent_path: currentFolderPath.split('/').slice(0, -1).join('/') || '/',
                folders: Array.from(document.querySelectorAll('.folder-item')).map(item => ({
                    path: item.dataset.path,
                    name: item.querySelector('.folder-name').textContent.replace('ğŸ“ ', ''),
                    file_count: parseInt(item.querySelector('.folder-stats').textContent.replace('ãƒ•ã‚¡ã‚¤ãƒ«', ''))
                }))
            });
        }

        // é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤ºæ›´æ–°
        function updateSelectedFoldersDisplay() {
            const selectedFoldersDiv = document.getElementById('selectedFolders');
            const selectedFolderList = document.getElementById('selectedFolderList');
            
            if (selectedFolderPaths.length === 0) {
                selectedFoldersDiv.style.display = 'none';
                return;
            }
            
            selectedFoldersDiv.style.display = 'block';
            selectedFolderList.innerHTML = selectedFolderPaths.map(path => `
                <div class="selected-folder-item" style="display: flex; justify-content: space-between; align-items: center; padding: 5px; border: 1px solid #ddd; margin: 2px 0;">
                    <span>ğŸ“ ${path}</span>
                    <button onclick="toggleFolderSelection('${path}', '')" class="btn btn-danger" style="padding: 2px 8px;">
                        å‰Šé™¤
                    </button>
                </div>
            `).join('');
        }

        // ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateFolderSetupButton() {
            const setupBtn = document.getElementById('folderSetupBtn');
            
            // ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
            const totalSelected = selectedFolderHandles.length + selectedFolderPaths.length;
            const nativeFolders = selectedFolderHandles.length;
            const fallbackFolders = selectedFolderPaths.length;
            
            setupBtn.disabled = totalSelected === 0;
            
            if (totalSelected === 0) {
                setupBtn.textContent = 'é¸æŠã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGã‚’è¨­å®š';
            } else if (nativeFolders > 0) {
                setupBtn.textContent = `é¸æŠã—ãŸ${nativeFolders}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGã‚’è¨­å®š`;
            } else {
                setupBtn.textContent = `é¸æŠã—ãŸ${fallbackFolders}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGã‚’è¨­å®š`;
            }
        }

        // ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGè¨­å®šå®Ÿè¡Œï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ– or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è‡ªå‹•åˆ¤å®šï¼‰
        async function setupRagFromFolders() {
            // ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ•ã‚©ãƒ«ãƒ€é¸æŠãŒåˆ©ç”¨å¯èƒ½ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ãŒã‚ã‚‹å ´åˆ
            if (selectedFolderHandles.length > 0) {
                await setupRagFromLocalFolders();
                return;
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒ‘ã‚¹æŒ‡å®šæ–¹å¼
            if (selectedFolderPaths.length === 0) {
                showNotification('ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (!confirm(`${selectedFolderPaths.length}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰RAGã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®RAGè¨­å®šã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            const setupBtn = document.getElementById('folderSetupBtn');
            const progressInfo = document.getElementById('folderProgressInfo');
            
            // UIæ›´æ–°
            setupBtn.disabled = true;
            setupBtn.textContent = 'å‡¦ç†ä¸­...';
            progressInfo.style.display = 'block';
            
            try {
                const chunkSize = parseInt(document.getElementById('chunkSize').value) || 1000;
                const chunkOverlap = parseInt(document.getElementById('chunkOverlap').value) || 200;
                
                const response = await fetch(`/api/rag/${chatbotId}/setup-from-folders`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        folder_paths: selectedFolderPaths,
                        chunk_size: chunkSize,
                        chunk_overlap: chunkOverlap
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(
                        `RAGè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼å‡¦ç†ã—ãŸãƒ•ã‚©ãƒ«ãƒ€: ${result.processed_folders}å€‹ã€ãƒ•ã‚¡ã‚¤ãƒ«: ${result.processed_files}å€‹ã€ãƒãƒ£ãƒ³ã‚¯: ${result.total_chunks}å€‹`, 
                        'success'
                    );
                    
                    // çµ±è¨ˆæƒ…å ±æ›´æ–°
                    loadRagStats();
                    loadChatbotInfo();
                    
                } else {
                    const error = await response.json();
                    showNotification(`RAGè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.detail}`, 'error');
                }
            } catch (error) {
                console.error('ãƒ•ã‚©ãƒ«ãƒ€RAGè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                showNotification('RAGè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            } finally {
                // UIå¾©å…ƒ
                setupBtn.disabled = false;
                updateFolderSetupButton();
                progressInfo.style.display = 'none';
            }
        }
    </script>
</body>
</html>